@page "/"
@inject IDialogService _dialogService;
@inject NavigationManager _navManager;
@inject ISessionHostingService _sessionManager;

<PageTitle>Index</PageTitle>

<MudContainer Class="d-flex align-center" Fixed="true">
    <MudGrid Spacing="4" Justify="Justify.Center">
        <MudItem sm="12" lg="4">
            <MudButton Class="d-flex align-center justify-center mud-width-full py-8"
                @onclick="NewSessionDialog" Variant="Variant.Filled" Color="Color.Primary" 
                StartIcon="@Icons.Material.Rounded.GroupAdd" Size="Size.Large">
                Create Session
            </MudButton>
        </MudItem>
        <MudItem sm="12" md="4">
            <MudButton Class="d-flex align-center justify-center mud-width-full py-8"
                @onclick="JoinSessionDialog" Variant="Variant.Filled" Color="Color.Primary" 
                StartIcon="@Icons.Material.Rounded.Hail" Size="Size.Large">
                Join Session
            </MudButton>
        </MudItem>
    </MudGrid>
</MudContainer>

<MudOverlay Visible="_preparingSession" DarkBackground="true" Absolute="true">
    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
</MudOverlay>

@code 
{    
    private bool _preparingSession = false;

    public async Task NewSessionDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("Label", "BGG Username");
        parameters.Add("DefaultValue", "FricKtion95");
        var dialog = await _dialogService.ShowAsync<InputDialog>("Whose library?", parameters);

        var dialogResult = await dialog.Result;

        if(!dialogResult.Canceled)
        {
            var bggUser = dialogResult.Data.ToString();

            _preparingSession = true;
            StateHasChanged();

            if(string.IsNullOrEmpty(bggUser))
                throw new ArgumentNullException("bggUser");

            var session = await _sessionManager.StartSession(bggUser, CurrentUser);

            _preparingSession = false;
            StateHasChanged();

            _navManager.NavigateTo($"/Session/{session.SessionId}");
        }
    }

    public async Task JoinSessionDialog() 
    {
        var inputDialogParameters = new DialogParameters();
        inputDialogParameters.Add("Label", "Session ID");
        var dialog = await _dialogService.ShowAsync<InputDialog>("Which session?", inputDialogParameters);
        
        var dialogResult = await dialog.Result;

        if(!dialogResult.Canceled)
        {
            // Only adding this because Allison asked me too...
            if(dialogResult.Data.ToString()?.ToLower() == "butt")
            {
                await _dialogService.ShowAsync<LuciDialog>();
            }
            else
            {
                int.TryParse(dialogResult.Data.ToString(), out int sessionId);

                if(_sessionManager.SessionIsReady(sessionId))
                {
                    _navManager.NavigateTo($"/Session/{sessionId}");
                }
                else
                {
                    var parameters = new DialogParameters();
                    parameters.Add("ErrorMessage", $"Could not find a session with ID '{sessionId}'");
                    await _dialogService.ShowAsync<ErrorDialog>("Unknown Session ID", parameters);
                }
            }
        }
    }
}